<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Height Map 3 Visualization with Trajectory</title>
    <!-- Using a recent version of Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.29.1.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f2f5;
        }
        h1 {
            color: #333;
        }
        #plotDiv {
            width: 80vw;
            height: 80vh;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <h1>Height Map 3 with Optimized Trajectory</h1>
    <div id="plotDiv"></div>

    <script>
        // --- Pre-calculate hill data for HeightMap3 ---
        const hillData3 = [];
        const Nx = 1000;
        const sigmas1 = Array.from({length: Nx}, (_, i) => 10 - 9 * i / (Nx - 1));
        const x1 = Array.from({length: Nx}, (_, i) => -25 - 50 * i / (Nx - 1));
        const y1 = Array.from({length: Nx}, (_, i) => -65 + 100 * i / (Nx - 1));
        const x2 = Array.from({length: Nx}, (_, i) => 25 + 50 * i / (Nx - 1));
        const y2 = Array.from({length: Nx}, (_, i) => 65 - 100 * i / (Nx - 1));
        const x3 = Array.from({length: Nx}, (_, i) => -50 + 50 * i / (Nx - 1));
        const y3 = Array.from({length: Nx}, (_, i) => 65 - 100 * i / (Nx - 1));
        const x4 = Array.from({length: Nx}, (_, i) => 50 - 50 * i / (Nx - 1));
        const y4 = Array.from({length: Nx}, (_, i) => -65 + 100 * i / (Nx - 1));
        const xs = [x1, x2, x3, x4], ys = [y1, y2, y3, y4];
        for (let i = 0; i < 4; i++) {
            for (let j = 0; j < Nx; j++) {
                hillData3.push([xs[i][j], ys[i][j], sigmas1[j], 1]);
            }
        }

        function heightMap3(x, y) {
            if (Math.abs(x) >= 99.99 || Math.abs(y) >= 49.99) return 0;
            let height = 0;
            for (const [cx, cy, sigma, A] of hillData3) {
                height += A * Math.exp(-((x - cx) ** 2 + (y - cy) ** 2) / (2 * sigma ** 2));
            }
            return height;
        }

        // --- Corrected Trajectory Data for Hmap3 ---
        const trajectoryData = [[-85,0],[-78.73265537,4.41583228],[-77.2620994,11.93993039],[-78.37599827,19.52547336],[-79.74916759,27.0683961],[-79.51457176,34.71161734],[-72.25394812,37.05165503],[-66.88286353,31.58061454],[-61.68292734,25.94661626],[-56.46271287,20.3314014],[-51.23683539,14.72145648],[-46.00998551,9.11241758],[-40.77364151,3.5122409],[-35.54413706,-2.09432316],[-30.31670119,-7.70281596],[-25.07909466,-13.30181185],[-19.85810069,-18.91630186],[-14.64924149,-24.54205178],[-9.47327546,-30.19807896],[-4.25573748,-35.815779],[3.33952888,-35.95919834],[4.25298077,-28.35031299],[3.07181931,-20.77495394],[1.81391871,-13.21197712],[0.73984392,-5.62069046],[-0.30463596,1.97472416],[-1.39411707,9.56381495],[-2.52203202,17.14728621],[-3.54701232,24.74493207],[-3.19799981,32.36840921],[2.97812399,36.86524479],[8.39126631,31.43583918],[13.52619096,25.74252797],[18.73834141,20.11982712],[23.95784025,14.50394705],[29.19107436,8.90086414],[34.42267665,3.29625757],[39.65397579,-2.30863197],[44.88701499,-7.91189692],[50.11912958,-13.51602524],[55.33739022,-19.13305573],[60.54247846,-24.76229473],[65.65362384,-30.47695428],[70.98960505,-35.98219194],[78.538134,-34.83483387],[79.31656547,-27.2383496],[78.26498067,-19.64391476],[77.37971974,-12.02829985],[78.78688884,-4.49194262],[85,0]];

        // --- Helper functions for upsampling ---
        function interp(x, xp, fp) {
            const n = xp.length;
            if (x < xp[0]) return fp[0];
            if (x > xp[n - 1]) return fp[n - 1];
            let i = 1;
            while (x > xp[i]) i++;
            const p = (x - xp[i - 1]) / (xp[i] - xp[i - 1]);
            return fp[i - 1] + p * (fp[i] - fp[i - 1]);
        }

        function upsampleAndProcessTrajectory(traj, numPoints) {
            const dists = [0];
            let totalDist = 0;
            for (let i = 1; i < traj.length; i++) {
                const dx = traj[i][0] - traj[i - 1][0];
                const dy = traj[i][1] - traj[i - 1][1];
                totalDist += Math.sqrt(dx * dx + dy * dy);
                dists.push(totalDist);
            }

            const newDists = [];
            for (let i = 0; i < numPoints; i++) {
                newDists.push(i * totalDist / (numPoints - 1));
            }

            const origX = traj.map(p => p[0]);
            const origY = traj.map(p => p[1]);

            const upsampledX = newDists.map(d => interp(d, dists, origX));
            const upsampledY = newDists.map(d => interp(d, dists, origY));
            const upsampledZ = upsampledX.map((x, i) => heightMap3(x, upsampledY[i]) + 0.02);

            return { upsampledX, upsampledY, upsampledZ };
        }
        
        // --- Generate data for the plot ---
        const resolution = 300;
        const x_min = -100, x_max = 100, y_min = -50, y_max = 50;
        const x_vals = Array.from({length: resolution}, (_, i) => x_min + (x_max - x_min) * i / (resolution - 1));
        const y_vals = Array.from({length: resolution}, (_, i) => y_min + (y_max - y_min) * i / (resolution - 1));
        const z_vals = y_vals.map(y => x_vals.map(x => heightMap3(x, y)));

        const plasmaColorscale = [[0.0,'#05045a'],[0.1,'#46039f'],[0.2,'#7201a8'],[0.3,'#9c179e'],[0.4,'#bd3786'],[0.5,'#d8576b'],[0.6,'#ed7953'],[0.7,'#fb9f3a'],[0.8,'#fdca26'],[0.9,'#f0f921'],[1.0,'#f0f921']];
        
        // --- Process trajectory for plotting ---
        const { upsampledX, upsampledY, upsampledZ } = upsampleAndProcessTrajectory(trajectoryData, 500);
        const originalX = trajectoryData.map(p => p[0]);
        const originalY = trajectoryData.map(p => p[1]);
        const originalZ = originalX.map((x, i) => heightMap3(x, originalY[i]) + 0.02);
        
        // --- Create the Plotly plot ---
        const data = [
            { // Surface
                x: x_vals, y: y_vals, z: z_vals,
                type: 'surface',
                colorscale: plasmaColorscale,
                showscale: false
            },
            { // Upsampled smooth line
                x: upsampledX, y: upsampledY, z: upsampledZ,
                mode: 'lines', type: 'scatter3d', name: 'Trajectory',
                line: { width: 6, color: 'white' },
                hoverinfo: 'none'
            },
            { // Small white markers for intermediate points
                x: originalX.slice(1, -1), y: originalY.slice(1, -1), z: originalZ.slice(1, -1),
                mode: 'markers', type: 'scatter3d', name: 'Waypoints',
                marker: { size: 4, color: 'white' },
                hoverinfo: 'none'
            },
            { // Large green start marker
                x: [originalX[0]], y: [originalY[0]], z: [originalZ[0]],
                mode: 'markers', type: 'scatter3d', name: 'Start',
                marker: { size: 8, color: 'lime' },
                hoverinfo: 'none'
            },
            { // Large red end marker
                x: [originalX[originalX.length - 1]], y: [originalY[originalY.length - 1]], z: [originalZ[originalZ.length - 1]],
                mode: 'markers', type: 'scatter3d', name: 'End',
                marker: { size: 8, color: 'red' },
                hoverinfo: 'none'
            }
        ];

        const layout = {
            title: '3D Surface Plot of HeightMap3 with Trajectory',
            autosize: true,
            scene: {
                xaxis: { title: 'X Coordinate', range: [-100, 100] },
                yaxis: { title: 'Y Coordinate', range: [-50, 50] },
                zaxis: { title: 'Height' },
                aspectratio: {x: 2, y: 1, z: 0.4}
            },
            margin: { l: 0, r: 0, b: 0, t: 40 },
            legend: { x: 0.8, y: 0.95 }
        };

        Plotly.newPlot('plotDiv', data, layout);
    </script>
</body>
</html>

